<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Monitoramento de Logs</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha512-Fo3rlrZj/k7ujTUcW2j2g1H/6ZMQ/mdkVtF5zQb1dU0Jt0jW8QcO3Xm+OQMMfBqI6pF5lX1H0KDZl8hc/UX3Lg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Fonte -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* Reset e tipografia */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #121212;
      color: #E0E0E0;
      font-family: 'Inter', sans-serif;
      line-height: 1.5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
    }

    h1 {
      margin-bottom: 1rem;
      font-weight: 700;
      font-size: 1.8rem;
      text-align: center;
      color: #A5FF90;
    }

    .controls {
      width: 100%;
      max-width: 800px;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 1rem;
    }

    .controls > * {
      flex: 1;
      min-width: 120px;
    }

    .refresh-button {
      padding: 0.6rem 1rem;
      border: 1px solid rgba(165, 255, 144, 0.5);
      border-radius: 0.5rem;
      backdrop-filter: blur(8px);
      background: rgba(165, 255, 144, 0.1);
      color: #A5FF90;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
    }
    .refresh-button:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px rgba(165, 255, 144, 0.5);
    }

    #filterInput {
      padding: 0.6rem;
      border: none;
      border-radius: 0.5rem;
      backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.05);
      color: #E0E0E0;
    }

    #toggleValue {
      margin-right: 0.3rem;
    }

    #logs {
      width: 100%;
      max-width: 800px;
    }

    .log-entry {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      backdrop-filter: blur(8px);
      background: rgba(255, 255, 255, 0.03);
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      margin-bottom: 0.75rem;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
      flex-wrap: wrap;
    }
    .log-entry .icon {
      font-size: 1.2rem;
      color: #A5FF90;
      width: 1.4rem;
      text-align: center;
    }
    .log-entry .key {
      font-weight: 500;
      color: #A5FF90;
      flex: 2;
      min-width: 100px;
    }
    .log-entry .timestamp {
      flex: 1;
      font-size: 0.85rem;
      color: #CCCCCC;
      text-align: right;
      min-width: 140px;
    }
    .log-entry .value {
      width: 100%;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #FFFFFF;
      display: none;
      word-break: break-all;
    }
    .show-values .value {
      display: block;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    /* Responsividade */
    @media (max-width: 600px) {
      .log-entry {
        flex-direction: column;
        align-items: flex-start;
      }
      .log-entry .timestamp {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <h1>Monitoramento de Logs</h1>

  <div class="controls">
    <button id="refreshButton" class="refresh-button">Atualizar Agora</button>
    <label title="Exibir/ocultar valores">
      <input type="checkbox" id="toggleValue"> Mostrar Valor
    </label>
    <input type="text" id="filterInput" placeholder="Filtrar por chave ou valor...">
  </div>

  <div id="logs"></div>

  <script>
    (function() {
      const userId = localStorage.getItem('username')?.toLowerCase() || '';
      const API_URL = 'https://tight-field-106d.tjslucasvl.workers.dev/?userId=' + encodeURIComponent(userId);

      // Customizações
      const nomesPersonalizados = {
        ondas: 'Ondas',
        movimentacoesProcessadas: 'Movimentações',
        result_state_monitor: 'Resultados Monitor',
        checkbox_state_monitor: 'Checkbox Monitor',
        dashboardHTML: 'Dashboard HTML',
        rankingArray: 'Ranking',
        logHistoricoMudancas: 'Histórico',
        reaba: 'Reabastecimento'
      };
      const icones = {
        ondas: 'fa-water',
        movimentacoesProcessadas: 'fa-exchange-alt',
        result_state_monitor: 'fa-chart-line',
        checkbox_state_monitor: 'fa-check-square',
        dashboardHTML: 'fa-desktop',
        rankingArray: 'fa-list-ol',
        logHistoricoMudancas: 'fa-history',
        reaba: 'fa-box-open'
      };
      const DEFAULT_ICON = 'fa-file-alt';

      let logsData = [];

      const logsContainer = document.getElementById('logs');
      const refreshButton = document.getElementById('refreshButton');
      const filterInput   = document.getElementById('filterInput');
      const toggleValue   = document.getElementById('toggleValue');

      refreshButton.addEventListener('click', fetchLogs);
      filterInput.addEventListener('input', renderLogs);
      toggleValue.addEventListener('change', () => {
        logsContainer.classList.toggle('show-values', toggleValue.checked);
      });

      document.addEventListener('DOMContentLoaded', fetchLogs);

      function fetchLogs() {
        refreshButton.disabled = true;
        refreshButton.textContent = 'Carregando...';
        fetch(API_URL)
          .then(res => {
            if (!res.ok) throw new Error('Erro ao buscar logs: ' + res.status);
            return res.json();
          })
          .then(data => {
            const raw = data?.dados ? JSON.parse(data.dados) : {};
            logsData = Object.entries(raw).map(([key, { value, timestamp }]) => ({
              key,
              value,
              timestamp: +timestamp
            }));
            // ordena mais recentes primeiro
            logsData.sort((a, b) => b.timestamp - a.timestamp);
            renderLogs();
          })
          .catch(err => {
            console.error(err);
            alert('Falha ao carregar logs.');
          })
          .finally(() => {
            refreshButton.disabled = false;
            refreshButton.textContent = 'Atualizar Agora';
          });
      }

      function renderLogs() {
        logsContainer.innerHTML = '';
        const filtro = filterInput.value.trim().toLowerCase();
        logsData.forEach(({ key, value, timestamp }) => {
          const label = nomesPersonalizados[key] || key;
          const txtValue = String(value);
          if (filtro && !label.toLowerCase().includes(filtro) && !txtValue.toLowerCase().includes(filtro)) {
            return;
          }

          const entry = document.createElement('div');
          entry.className = 'log-entry';

          const icon = document.createElement('i');
          icon.className = 'icon fas ' + (icones[key] || DEFAULT_ICON);
          entry.appendChild(icon);

          const spanKey = document.createElement('div');
          spanKey.className = 'key';
          spanKey.textContent = label;
          entry.appendChild(spanKey);

          const spanTs = document.createElement('div');
          spanTs.className = 'timestamp';
          spanTs.textContent = new Date(timestamp).toLocaleString('pt-BR');
          entry.appendChild(spanTs);

          const divValue = document.createElement('div');
          divValue.className = 'value';
          divValue.textContent = txtValue;
          entry.appendChild(divValue);

          logsContainer.appendChild(entry);
        });
      }
    })();
  </script>
</body>
</html>
