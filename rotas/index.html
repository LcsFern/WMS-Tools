---
layout: default
title: "Rotas e Padrões"
---

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Rotas e Padrões</title>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.4.2/css/all.css" />

  <style>
    /* === Estilos Gerais === */
    body {
      margin: 0; padding: 20px;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(45deg,#0f172a,#1e293b);
      color: #f8fafc; min-height: 100vh;
    }
    .container { max-width:1200px; margin:0 auto; }
    h1 {
      text-align:center; margin-bottom:40px;
      font-size:2.5rem; color:#00a65a;
      text-shadow:0 2px 10px rgba(0,166,90,0.3);
    }
    .section {
      margin-bottom:40px; padding:25px;
      background:rgba(255,255,255,0.05); backdrop-filter:blur(10px);
      border-radius:12px; box-shadow:0 4px 30px rgba(0,0,0,0.2);
      border:1px solid rgba(0,166,90,0.1);
    }
    h2 { font-size:1.8rem; margin-bottom:20px; text-align:center; color:#00a65a; }
    .alert {
      font-size:1.2rem; font-weight:bold; color:#34c759; text-align:center;
      margin-bottom:20px; padding:12px; background:rgba(52,199,89,0.1);
      border-radius:8px; border-left:4px solid #34c759;
    }
    .loader {
      display:flex; justify-content:center; align-items:center; height:100px;
    }
    .loader:after {
      content:""; width:40px; height:40px; border-radius:50%;
      border:6px solid #00a65a; border-color:#00a65a transparent #00a65a transparent;
      animation:spin 1.2s linear infinite;
    }
    @keyframes spin { from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .error-message {
      text-align:center; color:#ff3b30; padding:15px;
      background:rgba(255,59,48,0.1); border-radius:8px; margin:15px 0;
    }
    .table-container { overflow-x:auto; margin-bottom:20px; }
    table {
      width:100%; border-collapse:collapse;
      box-shadow:0 4px 20px rgba(0,0,0,0.1);
    }
    th, td {
      padding:12px 8px; text-align:left;
      border:1px solid rgba(255,255,255,0.1);
    }
    th {
      background:linear-gradient(90deg,#008d4c,#00a65a);
      color:#fff; font-weight:bold; position:sticky; top:0;
    }
    tr:nth-child(even){background:rgba(255,255,255,0.03)}
    tr:hover{background:rgba(0,166,90,0.1)}
    .button-container { display:flex; gap:15px; margin-top:20px; }
    .button-container.top-right { justify-content:flex-end; margin-bottom:10px; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      padding:0.8rem 1.6rem; font-size:1rem; font-weight:600; color:#fff;
      background:linear-gradient(90deg,#008d4c,#00a65a);
      border:none; border-radius:10px; cursor:pointer; transition:all .3s ease;
      box-shadow:0 4px 15px rgba(0,166,90,0.3); min-width:160px;
    }
    .btn i { margin-right:8px; font-size:1.2rem; }
    .btn:hover { transform:translateY(-2px); box-shadow:0 8px 25px rgba(0,166,90,0.4); }
    .btn:active{transform:translateY(1px)}
    @media(max-width:768px){
      body{padding:15px} h1{font-size:2rem} h2{font-size:1.5rem}
      .btn{width:100%;margin-bottom:10px}
      .button-container{flex-direction:column}
    }
    .badge {
      display:inline-block; padding:3px 8px; font-size:.8rem; font-weight:bold;
      background:#00a65a; color:#fff; border-radius:12px; margin-left:10px;
    }
    .toast {
      position:fixed; top:20px; right:20px; padding:12px 20px;
      background:#00a65a; color:#fff; border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      transform:translateY(-100px); opacity:0; transition:all .3s ease; z-index:1000;
    }
    .toast.show{transform:translateY(0);opacity:1;}

    /* === Estilos de Bloqueio === */
    .grade-bloqueio {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(8px);
  z-index: 9999;
  display: flex;
  justify-content: center;
  align-items: center;
}

.grade-bloqueio-conteudo {
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid #00a65a;
  border-radius: 16px;
  padding: 40px;
  text-align: center;
  box-shadow: 0 0 30px rgba(0, 166, 90, 0.3);
  animation: pulsar 2s infinite;
  max-width: 90%;
}

.icone-alerta {
  font-size: 5rem;
  color: #ff3b30;
  margin-bottom: 20px;
  animation: tremer 0.3s infinite;
}

.grade-bloqueio h2 {
  font-size: 2.5rem;
  color: #ff3b30;
  margin-bottom: 15px;
}

.grade-bloqueio p {
  font-size: 1.5rem;
  color: #fff;
  margin-bottom: 10px;
}

.motivo-bloqueio {
  font-size: 1.2rem !important;
  color: #ffd700 !important;
  margin-top: 20px;
}

@keyframes pulsar {
  0% { transform: scale(1); }
  50% { transform: scale(1.03); }
  100% { transform: scale(1); }
}

@keyframes tremer {
  0% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  50% { transform: translateX(0); }
  75% { transform: translateX(2px); }
  100% { transform: translateX(0); }
}
  </style>
</head>
<body>
  <div id="grade-bloqueio" style="display:none" class="grade-bloqueio">
    <div class="grade-bloqueio-conteudo">
      <i class="fa-solid fa-triangle-exclamation icone-alerta"></i>
      <h2>GRADE NÃO CARREGADA</h2>
      <p>FAVOR CARREGAR A GRADE</p>
      <p class="motivo-bloqueio"></p>
    </div>
  </div>
  <div class="container">
    <h1><i class="fa-solid fa-pen-ruler"></i> Rotas e Padrões</h1>
    <div id="toast" class="toast"></div>

    <!-- Seção Padrões -->
    <div class="section" id="padroes-section">
      <h2><i class="fa-solid fa-scale-balanced"></i> PADRÕES <span id="padroes-count" class="badge">0</span></h2>
      <div class="alert" id="padroes-alert"></div>
      <div id="padroes-loader" class="loader"></div>
      <div id="padroes-error" class="error-message" style="display:none;"></div>
      <div class="table-container">
        <table id="padroes-table">
          <thead><tr><th>OE</th><th>PLACA</th><th>QTD PALLETS</th><th>DESTINO</th><th>PADRÃO</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="button-container">
        <button id="btn-exportar-pdf" class="btn">
          <i class="fas fa-file-pdf"></i> Exportar PDF
        </button>
      </div>
    </div>

    <!-- Seção Rotas -->
    <div class="section" id="rotas-section">
      <h2><i class="fa-solid fa-road"></i> ROTAS DE VIAGEM <span id="rotas-count" class="badge">0</span></h2>
      <div class="button-container top-right">
        <button id="btn-exportar-rotas-pdf" class="btn">
          <i class="fas fa-file-pdf"></i> Exportar PDF
        </button>
        <button id="btn-copiar-oes" class="btn">
          <i class="fas fa-clipboard"></i> Copiar OEs
        </button>
      </div>
      <div id="rotas-loader" class="loader"></div>
      <div id="rotas-error" class="error-message" style="display:none;"></div>
      <div class="table-container">
        <table id="rotas-table">
          <thead><tr><th>OE</th><th>PLACA</th><th>QTD PALLETS</th><th>DESTINO</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- jsPDF & AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    // Funções utilitárias
    function showToast(msg,dur=3000){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), dur);
    }
    function showError(id,msg){
      const el = document.getElementById(id);
      el.textContent = msg;
      el.style.display = 'block';
    }
    function hideLoader(id){
      document.getElementById(id).style.display = 'none';
    }

    (async function(){
  // Função para verificar se a grade está carregada corretamente
  function verificarGradeValida() {
    // Verifica se existe grade no localStorage
    const raw = localStorage.getItem('gradeCompleta');
    if (!raw) {
      return {
        valida: false,
        motivo: ""
      };
    }
    
    try {
      // Verifica se é um JSON válido
      const grade = JSON.parse(raw);
      if (!Array.isArray(grade) || grade.length === 0) {
        return {
          valida: false,
          motivo: "O formato da grade é inválido ou está vazio."
        };
      }
      
      
      // Verifica se em algum lugar da grade existe o padrão de data DD/mmm
      const regexData = /\d{1,2}\/(jan|fev|mar|abr|mai|jun|jul|ago|set|out|nov|dez)/i;
      const gradeString = JSON.stringify(grade);
      
      if (!regexData.test(gradeString)) {
        return {
          valida: false,
          motivo: "A GRADE carregada Via Ondas não funciona nessa tela."
        };
      }
      
      return { valida: true };
      
    } catch (e) {
      return {
        valida: false,
        motivo: "Erro ao processar a grade: " + e.message
      };
    }
  }

  // Verifica se a grade é válida
  const verificacao = verificarGradeValida();
  
  // Se não for válida, exibe o bloqueio e encerra a execução
  if (!verificacao.valida) {
    const bloqueio = document.getElementById('grade-bloqueio');
    const motivo = bloqueio.querySelector('.motivo-bloqueio');
    
    motivo.textContent = verificacao.motivo;
    bloqueio.style.display = 'flex';
    
    // Esconde os loaders para evitar que continuem rodando
    document.getElementById('padroes-loader').style.display = 'none';
    document.getElementById('rotas-loader').style.display = 'none';
    
    // Mostra mensagens de erro nas seções
    ['padroes', 'rotas'].forEach(sec => {
      hideLoader(`${sec}-loader`);
      showError(`${sec}-error`, 'Grade inválida ou não carregada');
    });
    
    // Encerra a função para não carregar o resto do site
    return;
  }

  try {
    // Carrega JSONs (continua o código original aqui)
    const padraoArr = await (await fetch('padrao.json')).json();
    const padroes   = padraoArr[0] || {};
    const rotasArr  = await (await fetch('rotas.json')).json();


        // Recupera gradeCompleta do localStorage
        const raw = localStorage.getItem('gradeCompleta');
        if (!raw) {
          ['padroes','rotas'].forEach(sec=>{
            hideLoader(`${sec}-loader`);
            showError(`${sec}-error`, 'Dados não encontrados');
          });
          return;
        }
        const grade = JSON.parse(raw);
        if (!Array.isArray(grade)) throw new Error('Formato inválido');

        // Data atual formatada
        const hoje = new Date().toLocaleDateString('pt-BR');
        document.getElementById('padroes-alert').textContent = `ATENÇÃO (${hoje})`;

        // Helpers de processamento
        const extrai = d => Object.keys(padroes).find(k=> (d||'').toUpperCase().includes(k))||null;
        const kmNum  = s => parseFloat((s||'').replace(' km','').replace(',','.'))||0;
        const qtd    = i => i['QTD PALLETS']||'-';

        // === Processa Padrões ===
        const tbP = document.querySelector('#padroes-table tbody');
        let cntP = 0;
        for (const i of grade) {
          const key = extrai(i.DESTINO);
          if (!key) continue;
          cntP++;
          tbP.insertAdjacentHTML('beforeend', `
            <tr>
              <td>${i.OE||'-'}</td>
              <td>${i['PLACA ROTEIRIZADA']||'-'}</td>
              <td>${qtd(i)}</td>
              <td>${i.DESTINO||'-'}</td>
              <td>${padroes[key].replace(' e ', '\n e ')}</td>
            </tr>
          `);
        }
        document.getElementById('padroes-count').textContent = cntP;
        hideLoader('padroes-loader');

        // === Processa Rotas ===
        const tbR = document.querySelector('#rotas-table tbody');
        let cntR = 0, arrO = [], seen = new Set();
        for (const i of grade) {
          if (!i.OE || seen.has(i.OE)) continue;
          const dUp = (i.DESTINO||'').toUpperCase();
          for (const r of rotasArr) {
            if (dUp.includes(r.CIDADE.toUpperCase()) && kmNum(r.KM) > 100) {
              seen.add(i.OE);
              cntR++;
              arrO.push(i.OE);
              tbR.insertAdjacentHTML('beforeend', `
                <tr>
                  <td>${i.OE}</td>
                  <td>${i['PLACA ROTEIRIZADA']||'-'}</td>
                  <td>${qtd(i)}</td>
                  <td>${i.DESTINO||'-'}</td>
                </tr>
              `);
              break;
            }
          }
        }
        document.getElementById('rotas-count').textContent = cntR;
        hideLoader('rotas-loader');

        // === Exportar Padrões PDF ===
        document.getElementById('btn-exportar-pdf').addEventListener('click', ()=>{
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
          const w = doc.internal.pageSize.getWidth();
          const y = 25;

          // Cabeçalho: "ATENÇÃO" e data
          doc.setFont('helvetica','bold');
          doc.setFontSize(45);
          doc.setTextColor(0,0,0);
          doc.text('ATENÇÃO', w * 0.35, y, { align:'center' });
          doc.text(hoje,      w * 0.65, y, { align:'center' });

          // Monta tabela de padrões
          const headers = [['OE','PLACA','QTD PALLETS','DESTINO','PADRÃO']];
          const body = Array.from(tbP.querySelectorAll('tr')).map(r=>
            Array.from(r.cells).map(c=>c.textContent)
          );

          doc.autoTable({
            head: headers,
            body: body,
            startY: 35,
            theme: 'grid',
            margin: { left:10, right:10 },
            headStyles: {
              fillColor:[0, 60, 20], // verde escuro
              textColor:255,
              fontStyle:'bold',
              lineWidth: 1.5,
              lineColor:[0,0,0]
            },
            styles: {
              font:'helvetica',
              fontStyle:'bold',
              fontSize:24,      // fonte uniforme para todas as colunas
              halign:'center',
              cellPadding:3,
              lineWidth: 1.5,
              lineColor:[0,0,0],
              textColor: [0, 0, 0]
            },
            didParseCell: data => {
              // Ajuste: mantém QTD PALLETS com mesma fonte que as outras colunas, removida a customização
              if (data.section==='head' && data.column.index===2) {
                data.cell.styles.fillColor = [0, 60, 20]; // verde escuro para cabeçalho QTD PALLETS
              }
            },
            pageBreak: 'avoid'
          });

          doc.save(`Padroes_${hoje.replace(/\//g,'-')}.pdf`);
          showToast('PDF exportado com sucesso!');
        });

        // === Exportar Rotas PDF ===
        document.getElementById('btn-exportar-rotas-pdf').addEventListener('click', ()=>{
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
          const w = doc.internal.pageSize.getWidth();

          // Título centralizado
          doc.setFont('helvetica','bold');
          doc.setFontSize(20);
          doc.setTextColor(0,0,0);
          doc.text(`Rotas de Viagem (${hoje})`, w/2, 20, { align:'center' });

          // Monta tabela de rotas
          const headers = [['OE','PLACA','QTD PALLETS','DESTINO']];
          const body = Array.from(tbR.querySelectorAll('tr')).map(r=>
            Array.from(r.cells).map(c=>c.textContent)
          );

          doc.autoTable({
            head: headers,
            body: body,
            startY: 30,
            theme: 'grid',
            margin: { left:10, right:10 },
            headStyles: {
              fillColor:[0,166,90],
              textColor:255,
              fontStyle:'bold',
              lineWidth: 0.5,         // Ajuste: bordas do cabeçalho mais finas
              lineColor:[0,0,0]
            },
            styles: {
              font:'helvetica',
              fontStyle:'bold',
              fontSize:12,
              cellPadding:3,
              lineWidth: 0.2,         // Ajuste: bordas gerais mais finas
              lineColor:[0,0,0],
              textColor: [0, 0, 0],
            },
            tableLineWidth: 0.2        // Ajuste: define espessura da borda da tabela
          });

          doc.save(`Rotas_${hoje.replace(/\//g,'-')}.pdf`);
          showToast('PDF de Rotas exportado!');
        });

        // === Copiar OEs ===
        document.getElementById('btn-copiar-oes').addEventListener('click', async ()=>{
          if (!arrO.length) return showToast('Nenhuma OE para copiar!');
          try {
            await navigator.clipboard.writeText(arrO.join(','));
          } catch {
            // fallback para navegadores sem API moderna
            const ta = document.createElement('textarea');
            ta.value = arrO.join(',');
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
          }
          showToast(`${arrO.length} OEs copiadas!`);
        });

      } catch(e) {
        console.error(e);
      }
    })();
  </script>
</body>
</html>
